name: gsdk

on:
  push:
    branches: [ "main" ]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Optional: cache the build output or ccache, not system directories
      - name: Cache build
        uses: actions/cache@v4
        with:
          path: build   # cache your build dir or ccache dir (e.g. ~/.cache/ccache)
          key: ${{ runner.os }}-build-${{ hashFiles('**/Makefile') }}

      - name: Install dependencies & clang-20
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg software-properties-common ca-certificates lsb-release
          # Use the LLVM install script to add the apt repo and install clang-20
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 20
          # Add clang bin to the job PATH for subsequent steps (this persists for the remainder of the job)
          echo "/usr/lib/llvm-20/bin" >> $GITHUB_PATH

      - name: Show clang version (sanity check)
        run: |
          which clang-20
          clang-20 --version

      - name: Build
        run: |
          # either rely on clang-20 being in PATH (we wrote to $GITHUB_PATH above)
          make CC=clang-20

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: build   # upload the build directory (relative to workspace)

  sha-test:
    needs: [build, log-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run sha test
        run: |
          chmod +x build/tests/sha_test
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/tests/sha_test
  
  hash-test:
    needs: [build, log-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run hash test
        run: |
          chmod +x build/tests/hash_test
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/tests/hash_test
  
  sync-test:
    needs: [build, log-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run sync test
        run: |
          chmod +x build/tests/sync_test
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/tests/sync_test
  
  pack-test:
    needs: [build, log-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run pack test
        run: |
          chmod +x build/tests/pack_test
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/tests/pack_test
  
  array-test:
    needs: [pack-test, sync-test, hash-test, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run array test
        run: |
          chmod +x build/tests/array_test
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/tests/array_test
  
  bitmap-test:
    needs: [pack-test, sync-test, hash-test, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run bitmap test
        run: |
          chmod +x build/tests/bitmap_test
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/tests/bitmap_test
  
  cache-test:
    needs: [pack-test, sync-test, hash-test, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run cache test
        run: |
          chmod +x build/tests/cache_test
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/tests/cache_test

  circular-buffer-test:
    needs: [pack-test, sync-test, hash-test, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run circular buffer test
        run: |
          chmod +x build/tests/circular_buffer_test
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/tests/circular_buffer_test

  dict-test:
    needs: [pack-test, sync-test, hash-test, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run dict test
        run: |
          chmod +x build/tests/dict_test
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/tests/dict_test

  double-queue-test:
    needs: [pack-test, sync-test, hash-test, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run double queue test
        run: |
          chmod +x build/tests/double_queue_test
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/tests/double_queue_test

  queue-test:
    needs: [pack-test, sync-test, hash-test, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run queue test
        run: |
          chmod +x build/tests/queue_test
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/tests/queue_test
  
  priority-queue-test:
    needs: [pack-test, sync-test, hash-test, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run priority queue test
        run: |
          chmod +x build/tests/priority_queue_test
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/tests/priority_queue_test
  
  stack-test:
    needs: [pack-test, sync-test, hash-test, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run stack test
        run: |
          chmod +x build/tests/stack_test
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/tests/stack_test

  set-test:
    needs: [pack-test, sync-test, hash-test, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run set test
        run: |
          chmod +x build/tests/set_test
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/tests/set_test

  tuple-test:
    needs: [pack-test, sync-test, hash-test, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run tuple test
        run: |
          chmod +x build/tests/tuple_test
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/tests/tuple_test
  
  base64-test:
    needs: [build, log-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run base64 test
        run: |
          chmod +x build/tests/base64_test
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/tests/base64_test
  
  json-test:
    needs: [hash-test, sync-test, array-test, dict-test, log-example, hash-example, sync-example, array-example, dict-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run json test
        run: |
          chmod +x build/tests/json_test
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/tests/json_test

  log-example:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run log example
        run: |
          chmod +x build/examples/log_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/log_example

  hash-example:
    needs: [hash-test, log-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run hash example
        run: |
          chmod +x build/examples/hash_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/hash_example

  sha-example:
    needs: [sha-test, log-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run sha example
        run: |
          chmod +x build/examples/sha_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/sha_example

  rsa-example:
    needs: [log-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run rsa example
        run: |
          chmod +x build/examples/rsa_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/rsa_example
  
  digital-signature-example:
    needs: [sha-test, log-example, sha-example, rsa-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run digital signature example
        run: |
          chmod +x build/examples/digital_signature_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/digital_signature_example

  pack-example:
    needs: [pack-test, log-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run pack example
        run: |
          chmod +x build/examples/pack_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/pack_example
  
  sync-example:
    needs: [log-example, sync-test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run sync example
        run: |
          chmod +x build/examples/sync_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/sync_example

  array-example:
    needs: [array-test, hash-test, pack-test, sync-test, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run array example
        run: |
          chmod +x build/examples/array_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/array_example

  bitmap-example:
    needs: [bitmap-test, hash-test, pack-test, sync-test, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run bitmap example
        run: |
          chmod +x build/examples/bitmap_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/bitmap_example

  cache-example:
    needs: [hash-test, pack-test, sync-test, cache-test, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run cache example
        run: |
          chmod +x build/examples/cache_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/cache_example
  
  circular-buffer-example:
    needs: [circular-buffer-test, hash-test, pack-test, sync-test, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run circular buffer example
        run: |
          chmod +x build/examples/circular_buffer_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/circular_buffer_example

  dict-example:
    needs: [dict-test, hash-test, pack-test, sync-test, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run dict example
        run: |
          chmod +x build/examples/dict_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/dict_example
  
  double-queue-example:
    needs: [double-queue-test, hash-test, pack-test, sync-test, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run double queue example
        run: |
          chmod +x build/examples/double_queue_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/double_queue_example
  
  priority-queue-example:
    needs: [priority-queue-test, hash-test, pack-test, sync-test, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run priority queue example
        run: |
          chmod +x build/examples/priority_queue_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/priority_queue_example
  
  queue-example:
    needs: [queue-test, hash-test, pack-test, sync-test, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run queue example
        run: |
          chmod +x build/examples/queue_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/queue_example
  
  set-example:
    needs: [set-test, hash-test, pack-test, sync-test, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run set example
        run: |
          chmod +x build/examples/set_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/set_example

  stack-example:
    needs: [stack-test, hash-test, pack-test, sync-test, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run stack example
        run: |
          chmod +x build/examples/stack_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/stack_example

  tuple-example:
    needs: [tuple-test, hash-test, pack-test, sync-test, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run tuple example
        run: |
          chmod +x build/examples/tuple_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/tuple_example

  base64-example:
    needs: [build, base64-test, log-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run base64 example
        run: |
          chmod +x build/examples/base64_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/base64_example

  json-example:
    needs: [hash-test, sync-test, array-test, dict-test, json-test, log-example, hash-example, sync-example, array-example, dict-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run json example
        run: |
          chmod +x build/examples/json_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/json_example ${{github.workspace}}/resources/reflection/json_example_1.json

  parallel-example:
    needs: [hash-test, sync-test, array-test, dict-test, json-test, log-example, hash-example, sync-example, array-example, dict-example, json-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run parallel example
        run: |
          chmod +x build/examples/parallel_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/parallel_example
