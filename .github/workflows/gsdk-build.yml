name: gsdk

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Optional: cache the build output or ccache, not system directories
      - name: Cache build
        uses: actions/cache@v4
        with:
          path: build   # cache your build dir or ccache dir (e.g. ~/.cache/ccache)
          key: ${{ runner.os }}-build-${{ hashFiles('**/Makefile') }}

      - name: Install dependencies & clang-20
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg software-properties-common ca-certificates lsb-release
          # Use the LLVM install script to add the apt repo and install clang-20
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 20
          # Add clang bin to the job PATH for subsequent steps (this persists for the remainder of the job)
          echo "/usr/lib/llvm-20/bin" >> $GITHUB_PATH

      - name: Show clang version (sanity check)
        run: |
          which clang-20
          clang-20 --version

      - name: Build
        run: |
          # either rely on clang-20 being in PATH (we wrote to $GITHUB_PATH above)
          make CC=clang-20

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: build   # upload the build directory (relative to workspace)

  core-examples:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build   # downloads into ./build

      - name: Run examples
        run: |
          # example: run binaries from build/examples
          ls -al build/examples || true
          chmod +x build/examples/* || true
          # run any core example(s) you need; replace the line below:
          if [ -x build/examples/core_example ]; then
            build/examples/core_example
          else
            echo "no core_example to run"
          fi

  log-example:
    needs: core-examples
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run log example
        run: |
          chmod +x build/examples/log_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/log_example

  hash-example:
    needs: [core-examples, log-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run hash example
        run: |
          chmod +x build/examples/hash_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/hash_example

  sha-example:
    needs: [core-examples, log-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run sha example
        run: |
          chmod +x build/examples/sha_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/sha_example

  rsa-example:
    needs: [core-examples, log-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run rsa example
        run: |
          chmod +x build/examples/rsa_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/rsa_example
  
  digital-signature-example:
    needs: [core-examples, log-example, sha-example, rsa-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run digital signature example
        run: |
          chmod +x build/examples/digital_signature_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/digital_signature_example

  pack-example:
    needs: [core-examples, log-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run pack example
        run: |
          chmod +x build/examples/pack_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/pack_example
  
  sync-example:
    needs: [core-examples, log-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run sync example
        run: |
          chmod +x build/examples/sync_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/sync_example

  data-examples:
    needs: [core-examples, log-example, hash-example, pack-example, sync-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build   # downloads into ./build

      - name: Run examples
        run: |
          # example: run binaries from build/examples
          ls -al build/examples || true
          chmod +x build/examples/* || true
          # run any core example(s) you need; replace the line below:
          if [ -x build/examples/core_example ]; then
            build/examples/core_example
          else
            echo "no core_example to run"
          fi

  array-example:
    needs: [data-examples, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run array example
        run: |
          chmod +x build/examples/array_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/array_example

  bitmap-example:
    needs: [data-examples, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run bitmap example
        run: |
          chmod +x build/examples/bitmap_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/bitmap_example

  cache-example:
    needs: [data-examples, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run cache example
        run: |
          chmod +x build/examples/cache_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/cache_example

  dict-example:
    needs: [data-examples, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run dict example
        run: |
          chmod +x build/examples/dict_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/dict_example
  
  double-queue-example:
    needs: [data-examples, log-example, sync-example, hash-example, pack-example]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: build

      - name: Run double queue example
        run: |
          chmod +x build/examples/double_queue_example
          export LD_LIBRARY_PATH=${{github.workspace}}/build/lib:$LD_LIBRARY_PATH
          ./build/examples/double_queue_example
